<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 CBT</title>
    <style>
        /* CSS는 이전과 동일합니다 */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        select, .button { width: 100%; padding: 12px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .button { color: white; border: none; cursor: pointer; margin-top: 10px; }
        .primary-button { background-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; }
        #question { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
        .options-container { list-style: none; padding: 0; }
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        textarea { height: 120px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="subject-view">
            <h2>과목 선택</h2>
            <p>공부할 과목을 선택하세요.</p>
            <div id="subject-list">로딩 중...</div>
        </div>

        <div id="quiz-view" class="hidden">
            <h2 id="quiz-header"></h2>
            <div id="quiz-body">
                <div id="question"></div>
                <ul class="options-container" id="options-container"></ul>
                <button id="submit-btn" class="button primary-button">정답 제출</button>
            </div>
            <hr style="margin: 20px 0;">
            <button class="button secondary-button" onclick="showView('add-view')">✏️ 이 과목에 문제 추가하기</button>
            <button class="button secondary-button" onclick="showView('subject-view')">↩️ 과목 선택으로 돌아가기</button>
        </div>

        <div id="add-view" class="hidden">
            <h2 id="add-header">문제 추가</h2>
            <div class="form-group"><label for="new-question">문제</label><input type="text" id="new-question"></div>
            <div class="form-group"><label for="new-answer">정답</label><input type="text" id="new-answer"></div>
            <div class="form-group"><label for="new-part">파트</label><select id="new-part"></select></div>
            <div class="form-group">
                <label>보기</label>
                <div id="new-options-container">
                    <input type="text" class="new-option" placeholder="보기 1"><input type="text" class="new-option" placeholder="보기 2">
                </div>
                <button onclick="addOptionField()">보기 필드 추가</button>
            </div>
            <button class="button primary-button" onclick="addSingleQuestion()">DB에 저장</button>
            <button class="button secondary-button" onclick="showView('quiz-view')">← 돌아가기</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // 1단계에서 복사한 firebaseConfig 코드를 여기에 붙여넣으세요
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 전역 변수
        let currentSubjectId = null;
        let currentSubjectData = {};
        let questions = [];
        let currentQuiz = 0;
        let score = 0;

        // HTML 요소
        const views = ['subject-view', 'quiz-view', 'add-view'];
        
        /** 화면 전환 함수 */
        function showView(viewId) {
            views.forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        }

        /** [신규] 과목 목록 불러오기 */
        async function loadSubjects() {
            showView('subject-view');
            const subjectListDiv = document.getElementById('subject-list');
            subjectListDiv.innerHTML = '과목 로딩 중...';
            
            try {
                const snapshot = await db.collection('subjects').get();
                if (snapshot.empty) {
                    subjectListDiv.innerHTML = '과목이 없습니다. Firebase 콘솔에서 첫 과목을 추가해주세요.';
                    return;
                }
                
                subjectListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const subject = doc.data();
                    const button = document.createElement('button');
                    button.textContent = `${subject.name} (${subject.questionCount || 0}문제)`;
                    button.className = 'button primary-button';
                    button.onclick = () => selectSubject(doc.id, subject);
                    subjectListDiv.appendChild(button);
                });
            } catch (error) {
                console.error("과목 로드 오류:", error);
                subjectListDiv.innerHTML = '과목을 불러오는 데 실패했습니다.';
            }
        }
        
        /** [신규] 과목 선택 시 실행 */
        function selectSubject(subjectId, subjectData) {
            currentSubjectId = subjectId;
            currentSubjectData = subjectData;
            document.getElementById('quiz-header').textContent = `${subjectData.name} 퀴즈`;
            loadQuestionsForSubject();
        }

        /** [신규] 선택된 과목의 문제들 불러오기 */
        async function loadQuestionsForSubject() {
            showView('quiz-view');
            document.getElementById('quiz-body').innerHTML = '<p>문제 로딩 중...</p>';
            
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            currentQuiz = 0;
            score = 0;
            displayCurrentQuiz();
        }
        
        /** 현재 퀴즈 표시 (기존 로직과 유사) */
        function displayCurrentQuiz() {
            const quizBody = document.getElementById('quiz-body');
            if (questions.length === 0) {
                 quizBody.innerHTML = "이 과목에 문제가 없습니다. 새 문제를 추가해보세요.";
                 return;
            }
            // 퀴즈 화면 기본 HTML 구조 복원
            quizBody.innerHTML = `
                <div id="question"></div>
                <ul class="options-container" id="options-container"></ul>
                <button id="submit-btn" class="button primary-button">정답 제출</button>
            `;
            // 퀴즈 내용 채우기
            const questionEl = document.getElementById('question');
            const optionsContainer = document.getElementById('options-container');
            const currentQuizData = questions[currentQuiz];
            questionEl.textContent = `${currentQuiz + 1}. ${currentQuizData.text}`;
            optionsContainer.innerHTML = '';
            currentQuizData.options.forEach(optionText => {
                const li = document.createElement('li');
                li.className = 'option';
                li.textContent = optionText;
                li.onclick = () => { /* ... 보기 선택 로직 ... */ };
                optionsContainer.appendChild(li);
            });
            // 제출 버튼 이벤트 다시 연결
            document.getElementById('submit-btn').onclick = submitAnswer;
        }

        /** [신규] 한 문제 추가 (서브컬렉션 & 데이터 중복 업데이트) */
        async function addSingleQuestion() {
            const text = document.getElementById('new-question').value.trim();
            const answer = document.getElementById('new-answer').value.trim();
            const partName = document.getElementById('new-part').value;
            const options = Array.from(document.querySelectorAll('.new-option')).map(i => i.value.trim()).filter(Boolean);

            if (!text || !answer || !partName || options.length < 2) return alert("모든 필드를 올바르게 입력해주세요.");

            const questionData = { text, options, answer, partName };
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const questionRef = subjectRef.collection('questions').doc();
            
            try {
                // 트랜잭션을 사용하여 문제 추가와 카운트 증가를 동시에 처리 (데이터 정합성 보장)
                await db.runTransaction(async (transaction) => {
                    const subjectDoc = await transaction.get(subjectRef);
                    if (!subjectDoc.exists) throw "과목 문서가 존재하지 않습니다!";
                    
                    const newCount = (subjectDoc.data().questionCount || 0) + 1;
                    transaction.update(subjectRef, { questionCount: newCount });
                    transaction.set(questionRef, questionData);
                });
                
                alert("성공! 문제가 데이터베이스에 저장되었습니다.");
                selectSubject(currentSubjectId, { ...currentSubjectData, questionCount: (currentSubjectData.questionCount || 0) + 1 });
            } catch (error) {
                console.error("문제 추가 오류: ", error);
                alert("오류가 발생했습니다.");
            }
        }
        
        // 문제 추가 화면으로 갈 때 파트 목록 채우기
        document.querySelector('button[onclick="showView(\'add-view\')"]').addEventListener('click', () => {
            document.getElementById('add-header').textContent = `[${currentSubjectData.name}] 문제 추가`;
            const partSelect = document.getElementById('new-part');
            partSelect.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const option = document.createElement('option');
                option.value = part;
                option.textContent = part;
                partSelect.appendChild(option);
            });
        });

        // 페이지 첫 로드 시 과목 목록 불러오기
        loadSubjects();
    </script>
</body>
</html>
