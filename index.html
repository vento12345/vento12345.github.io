<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        /* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤ */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        select, .button { width: 100%; padding: 12px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .button { color: white; border: none; cursor: pointer; margin-top: 10px; }
        .primary-button { background-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; }
        .danger-button { background-color: #dc3545; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        textarea { height: 120px; }
        .question-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 5px; }
        .question-item-text { flex-grow: 1; margin-right: 10px; }
        .question-item .button { width: auto; padding: 5px 10px; font-size: 0.9em; margin-top: 0; margin-left: 5px;}
    </style>
</head>
<body>
    <div class="container">
        <div id="subject-view">
            <h2>ê³¼ëª© ì„ íƒ</h2>
            <div id="subject-list">ë¡œë”© ì¤‘...</div>
        </div>

        <div id="quiz-view" class="hidden">
            <h2 id="quiz-header"></h2>
            <div id="quiz-body"></div>
            <hr style="margin: 20px 0;">
            <button class="button secondary-button" onclick="showManagementView()">ğŸ“‹ ë¬¸ì œ ê´€ë¦¬</button>
            <button class="button secondary-button" onclick="showView('subject-view')">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        
        <div id="management-view" class="hidden">
            <h2 id="management-header">ë¬¸ì œ ê´€ë¦¬</h2>
            <button class="button primary-button" onclick="showAddForm()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
            <button class="button primary-button" onclick="showView('bulk-add-view')">+ ì—¬ëŸ¬ ë¬¸ì œ í•œ ë²ˆì— ì¶”ê°€</button>
            <hr>
            <div id="question-list-container"></div>
            <button class="button secondary-button" onclick="showView('quiz-view')">â† í€´ì¦ˆ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            <div class="form-group"><label for="q-text">ë¬¸ì œ</label><input type="text" id="q-text"></div>
            <div class="form-group"><label for="q-answer">ì •ë‹µ</label><input type="text" id="q-answer"></div>
            <div class="form-group"><label for="q-part">íŒŒíŠ¸</label><select id="q-part"></select></div>
            <div class="form-group">
                <label>ë³´ê¸°</label>
                <div id="q-options-container"></div>
                <button onclick="addOptionField()">ë³´ê¸° í•„ë“œ ì¶”ê°€</button>
            </div>
            <button id="save-btn" class="button primary-button">ì €ì¥</button>
            <button class="button secondary-button" onclick="showView('management-view')">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
        </div>
        
        <div id="bulk-add-view" class="hidden">
            <h2>ğŸ“š ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€í•˜ê¸°</h2>
            <div class="form-group">
                <textarea id="bulk-text" placeholder="ë¬¸ì œ: ...\në³´ê¸°: ..., ...\nì •ë‹µ: ...\ní•´ì„¤: ...\n---"></textarea>
            </div>
            <button class="button primary-button" onclick="addBulkQuestions()">DBì— í•œ ë²ˆì— ì €ì¥í•˜ê¸°</button>
            <button class="button secondary-button" onclick="showView('management-view')">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // ì—¬ê¸°ì— ë³¸ì¸ì˜ firebaseConfig ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ì „ì—­ ë³€ìˆ˜ & HTML ìš”ì†Œ (ì´ì „ê³¼ ìœ ì‚¬)
        let currentSubjectId = null;
        let currentSubjectData = {};
        let questions = [];
        const views = ['subject-view', 'quiz-view', 'management-view', 'add-edit-view', 'bulk-add-view'];

        function showView(viewId) { views.forEach(id => document.getElementById(id).classList.toggle('hidden', id !== viewId)); }

        async function loadSubjects() { /* ì´ì „ê³¼ ë™ì¼ */ }
        function selectSubject(id, data) { /* ì´ì „ê³¼ ë™ì¼ */ }
        async function loadQuestionsForSubject() { /* ì´ì „ê³¼ ë™ì¼ */ }
        function displayCurrentQuiz() { /* ì´ì „ê³¼ ë™ì¼, UI êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì • í•„ìš” */ }

        /** [ì‹ ê·œ] ë¬¸ì œ ê´€ë¦¬ í™”ë©´ í‘œì‹œ */
        async function showManagementView() {
            showView('management-view');
            document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
            const container = document.getElementById('question-list-container');
            container.innerHTML = 'ë¬¸ì œ ëª©ë¡ ë¡œë”© ì¤‘...';
            
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            container.innerHTML = '';
            if (questions.length === 0) {
                container.innerHTML = '<p>ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            questions.forEach(q => {
                const item = document.createElement('div');
                item.className = 'question-item';
                item.innerHTML = `
                    <span class="question-item-text">${q.text}</span>
                    <div>
                        <button class="button secondary-button" onclick="showEditForm('${q.id}')">ìˆ˜ì •</button>
                        <button class="button danger-button" onclick="deleteQuestion('${q.id}', '${q.text.replace(/'/g, "\\'")}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        /** [ì‹ ê·œ] ë¬¸ì œ ì‚­ì œ í•¨ìˆ˜ */
        async function deleteQuestion(id, text) {
            if (!confirm(`'${text}' ë¬¸ì œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const questionRef = subjectRef.collection('questions').doc(id);

            try {
                await db.runTransaction(async (transaction) => {
                    const subjectDoc = await transaction.get(subjectRef);
                    const newCount = (subjectDoc.data().questionCount || 1) - 1;
                    transaction.update(subjectRef, { questionCount: newCount });
                    transaction.delete(questionRef);
                });
                alert('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showManagementView(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error("ë¬¸ì œ ì‚­ì œ ì˜¤ë¥˜:", error);
                alert('ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /** [ì‹ ê·œ] ë¬¸ì œ ì¶”ê°€ í¼ ë³´ì—¬ì£¼ê¸° */
        function showAddForm() {
            document.getElementById('add-edit-header').textContent = 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
            document.getElementById('editing-question-id').value = ''; // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹˜ì„ í‘œì‹œ
            
            // í¼ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('q-text').value = '';
            document.getElementById('q-answer').value = '';
            document.getElementById('q-options-container').innerHTML = '<input type="text" class="new-option" placeholder="ë³´ê¸° 1"><input type="text" class="new-option" placeholder="ë³´ê¸° 2">';
            
            populatePartSelect(); // íŒŒíŠ¸ ëª©ë¡ ì±„ìš°ê¸°
            document.getElementById('save-btn').onclick = saveQuestion; // ì €ì¥ ë²„íŠ¼ ê¸°ëŠ¥ ì—°ê²°
            showView('add-edit-view');
        }

        /** [ì‹ ê·œ] ë¬¸ì œ ìˆ˜ì • í¼ ë³´ì—¬ì£¼ê¸° */
        function showEditForm(id) {
            const question = questions.find(q => q.id === id);
            if (!question) return;

            document.getElementById('add-edit-header').textContent = 'ë¬¸ì œ ìˆ˜ì •';
            document.getElementById('editing-question-id').value = id; // ìˆ˜ì • ëª¨ë“œì„ì„ í‘œì‹œ
            
            // ê¸°ì¡´ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
            document.getElementById('q-text').value = question.text;
            document.getElementById('q-answer').value = question.answer;
            populatePartSelect(question.partName);
            
            const optionsContainer = document.getElementById('q-options-container');
            optionsContainer.innerHTML = '';
            question.options.forEach(opt => {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'new-option';
                input.value = opt;
                optionsContainer.appendChild(input);
            });
            
            document.getElementById('save-btn').onclick = saveQuestion;
            showView('add-edit-view');
        }
        
        /** [ì‹ ê·œ] ë¬¸ì œ ì €ì¥/ìˆ˜ì • í•¨ìˆ˜ */
        async function saveQuestion() {
            const id = document.getElementById('editing-question-id').value;
            const isEditing = !!id;
            
            const text = document.getElementById('q-text').value.trim();
            const answer = document.getElementById('q-answer').value.trim();
            const partName = document.getElementById('q-part').value;
            const options = Array.from(document.querySelectorAll('.new-option')).map(i => i.value.trim()).filter(Boolean);

            if (!text || !answer || !partName || options.length < 2) return alert("ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const questionData = { text, answer, partName, options };
            
            if (isEditing) { // ìˆ˜ì • ëª¨ë“œ
                await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(questionData);
                alert('ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else { // ì¶”ê°€ ëª¨ë“œ
                const subjectRef = db.collection('subjects').doc(currentSubjectId);
                const questionRef = subjectRef.collection('questions').doc();
                await db.runTransaction(async t => {
                    const subjectDoc = await t.get(subjectRef);
                    const newCount = (subjectDoc.data().questionCount || 0) + 1;
                    t.update(subjectRef, { questionCount: newCount });
                    t.set(questionRef, questionData);
                });
                alert('ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            showManagementView();
        }

        /** [ì‹ ê·œ] ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€ í•¨ìˆ˜ (ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì¶”ê°€) */
        async function addBulkQuestions() {
            const bulkText = document.getElementById('bulk-text').value.trim();
            const questionBlocks = bulkText.split('---');
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const questionsColRef = subjectRef.collection('questions');
            let addedCount = 0;

            try {
                await db.runTransaction(async t => {
                    const subjectDoc = await t.get(subjectRef);
                    
                    questionBlocks.forEach(block => {
                        // ... ë¸”ë¡ íŒŒì‹± ë¡œì§ (ì´ì „ê³¼ ìœ ì‚¬) ...
                        const qData = { /* íŒŒì‹±ëœ ë°ì´í„° */ };
                        if (qData.text && qData.answer) {
                           t.set(questionsColRef.doc(), qData);
                           addedCount++;
                        }
                    });

                    const newCount = (subjectDoc.data().questionCount || 0) + addedCount;
                    t.update(subjectRef, { questionCount: newCount });
                });
                
                if (addedCount > 0) {
                    alert(`${addedCount}ê°œì˜ ë¬¸ì œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    showManagementView();
                } else {
                    alert('ì–‘ì‹ì— ë§ëŠ” ë¬¸ì œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.error("ëŒ€ëŸ‰ ì¶”ê°€ ì˜¤ë¥˜: ", e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        /** ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ */
        function addOptionField() { /* ì´ì „ê³¼ ë™ì¼ */ }
        function populatePartSelect(selectedValue) {
            const partSelect = document.getElementById('q-part');
            partSelect.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const option = document.createElement('option');
                option.value = part;
                option.textContent = part;
                if (part === selectedValue) option.selected = true;
                partSelect.appendChild(option);
            });
        }

        // í˜ì´ì§€ ì²« ë¡œë“œ ì‹œ ê³¼ëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadSubjects();
        // -- ì´ ì•„ë˜ì— í€´ì¦ˆ í’€ì´ ë¡œì§(displayCurrentQuiz, submitAnswer ë“±)ì— ëŒ€í•œ í•¨ìˆ˜ë“¤ì„
        // -- ì´ì „ ì½”ë“œì—ì„œ ê°€ì ¸ì™€ í•„ìš”ì— ë§ê²Œ ìˆ˜ì •í•˜ì—¬ ë°°ì¹˜í•˜ë©´ ë©ë‹ˆë‹¤.
    </script>
</body>
</html>
